<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>THREE CIRCLES</title>
<style>
  html, body { height: 100%; margin: 0; }
  body {
    display: flex; justify-content: center; align-items: center;
    background: #f0f0f0; font-family: system-ui, sans-serif;
  }
  #circle-container {
    position: relative; width: 90vw; height: 90vw; max-width: 500px; max-height: 500px;
    border: 1px solid #ccc; background: #fff;
  }
  .circle { position: absolute; border-radius: 50%; cursor: pointer; user-select: none; touch-action: none; }
  #circle-red   { width: 100px; height: 100px; top: 60%; left: 40%; background: red; }
  #circle-blue  { width: 100px; height: 100px; top: 20%; left: 20%; background: blue; }
  #circle-green { width: 100px; height: 100px; top: 20%; left: 60%; background: green; }
</style>
</head>
<body>
  <div id="circle-container">
    <div id="circle-red" class="circle"></div>
    <div id="circle-blue" class="circle"></div>
    <div id="circle-green" class="circle"></div>
  </div>

<script>
// Replace with your GAS Web App URL
const ENDPOINT = "AKfycbyj-dZ-SZ1DXrxcUZsMWOx4gPBmV29aTu5VmDN3DmqFBczgXAPQypOR_g6u-yVq-h9ISg";

const circles = {
  red:   document.getElementById("circle-red"),
  blue:  document.getElementById("circle-blue"),
  green: document.getElementById("circle-green")
};

let selected = null, startY = 0, initialSize = 0, centerX = 0, centerY = 0;

function getRadius(el) {
  const w = parseFloat(getComputedStyle(el).width);
  return w / 2;
}

function getRID() {
  const p = new URLSearchParams(location.search);
  return p.get("rid") || "";
}

// Write radii to server using CORS-free image beacon
function writeRadii() {
  const payload = new URLSearchParams({
    mode: "write",
    rid: getRID(),
    red:   String(getRadius(circles.red)),
    blue:  String(getRadius(circles.blue)),
    green: String(getRadius(circles.green)),
    t: String(Date.now())
  }).toString();

  const img = new Image();
  img.src = `${ENDPOINT}?${payload}`;
}

// Resize from centre
function onPointerDown(e) {
  if (!(e.target.classList && e.target.classList.contains("circle"))) return;
  e.preventDefault();
  selected = e.target;
  startY = e.clientY ?? (e.touches && e.touches[0]?.clientY) ?? 0;
  initialSize = selected.clientWidth;
  centerX = selected.offsetLeft + initialSize / 2;
  centerY = selected.offsetTop  + initialSize / 2;
  if (e.pointerId != null) selected.setPointerCapture(e.pointerId);
  selected.addEventListener("pointermove", onPointerMove);
  selected.addEventListener("pointerup", onPointerUp);
  selected.addEventListener("pointercancel", onPointerUp);
  selected.style.outline = "2px dashed #ff0";
}

function onPointerMove(e) {
  if (!selected) return;
  const currentY = e.clientY ?? (e.touches && e.touches[0]?.clientY) ?? startY;
  const dy = currentY - startY;
  const newSize = Math.max(20, initialSize + dy);
  selected.style.width  = `${newSize}px`;
  selected.style.height = `${newSize}px`;
  selected.style.left   = `${centerX - newSize / 2}px`;
  selected.style.top    = `${centerY - newSize / 2}px`;
}

function onPointerUp(e) {
  if (!selected) return;
  if (e.pointerId != null) selected.releasePointerCapture(e.pointerId);
  selected.removeEventListener("pointermove", onPointerMove);
  selected.removeEventListener("pointerup", onPointerUp);
  selected.removeEventListener("pointercancel", onPointerUp);
  selected.style.outline = "none";
  writeRadii();
  selected = null;
}

function init() {
  Object.values(circles).forEach(el => {
    el.style.width = "100px"; el.style.height = "100px";
    el.addEventListener("pointerdown", onPointerDown, { passive: false });
  });
  writeRadii(); // save initial sizes in case participant never drags
}

window.addEventListener("load", init);
</script>
</body>
</html>
